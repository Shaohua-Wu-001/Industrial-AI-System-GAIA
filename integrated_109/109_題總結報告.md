# 109 題整合與分析總結報告

**日期**：2026-02-09
**任務**：從源頭優化，整合 109 題，檢查 Parser 參數處理，執行 Pipeline

---

## 📊 整合結果

### 資料來源
- **助教的 99 題**：來自 `LLM-planning-main/data/GAIA/gaia.infer/gaia.infer.jsonl`
  - Level 1: 38 題
  - Level 2: 50 題
  - Level 3: 11 題

- **現有的 10 題**：來自 `gaia_level3_tasks.json`
  - Level 3: 10 題

- **總共**：109 題
  - Level 1: 38 題
  - Level 2: 50 題
  - Level 3: 21 題（實際只偵測到 10 題，可能是資料問題）

### 整合檔案
- `gaia_109_tasks.json` (2860 KB)
- 統一格式為 `annotated_steps`

---

## 🔍 工具與參數分析

### 工具使用（整合後）
只使用了 **4 個**（含推理步驟）：
1. **None**（推理步驟）- 17,235 次（97.6%）
2. **web_fetch** - 223 次
3. **web_search** - 163 次
4. **calculate** - 40 次

### 參數使用
只使用了 **3 個**：
1. `web_fetch.url` - 223 次
2. `web_search.query` - 163 次
3. `calculate.expression` - 40 次

### 工具對應關係
| 助教的工具 | 我們的工具 | 對應狀態 |
|-----------|-----------|----------|
| web_search | web_search | ✓ 直接對應 |
| web_browser | web_fetch | 統一為抓取網頁 |
| download_file | web_fetch | 統一為抓取網頁 |
| calculator | calculate | ✓ 直接對應 |
| python_executor | calculate | 簡化為計算 |
| code_interpreter | calculate | 簡化為計算 |
| reasoning | **None** | 推理步驟 |
| submit_final_answer | **None** | 特殊步驟 |

---

## ✅ Pipeline 執行結果

### 驗證結果
- **總步驟數**：17,661 步
  - 工具步驟：426 步（2.4%）
  - 推理步驟：17,235 步（97.6%）
- **平均每題步驟數**：162 步

### 參數驗證
- **驗證步驟數**：426 步
- **有效步驟數**：426 步
- **整體驗證率**：**100%** ✓

### 題目驗證
- **100% 有效**：82 題（75.2%）
- **有錯誤**：27 題（24.8%）

---

## 📋 Schema 完整性檢查

### 我們的 tools_schema.json
- **總工具數**：43 個
- **平均參數數**：2.7 個
- **Schema 完整性**：✓ 所有工具都有完整的 type 和 description

### 參數對應問題
1. **參數名稱不一致**：
   - 助教：`max_results`
   - 我們：`num_results`

2. **缺少的參數**：
   - `engine`（web_search）
   - `action`（web_browser）
   - `query`（excel_reader）

3. **工具簡化**：
   - `python_executor` → `calculate`
   - `code_interpreter` → `calculate`

---

## 🎯 關鍵發現

### 優點
1. ✓ **整體驗證率 100%**：所有工具步驟的參數都符合 schema
2. ✓ **資料完整性高**：助教的 99 題都有完整的 DAG 結構和參數
3. ✓ **工具對應合理**：大部分工具都能成功對應

### 問題
1. ✗ **推理步驟比例過高**：97.6% 的步驟是推理步驟（None）
   - 原因：助教的資料中，每個 DAG 節點都包含 `thought` 步驟
   - 影響：實際可執行的工具步驟很少

2. ✗ **工具種類太少**：只用了 3 個工具（web_fetch, web_search, calculate）
   - 原因：工具對應規則將多種工具統一成少數幾個
   - 影響：失去了工具的多樣性

3. ✗ **Level 3 題目數不符**：應該是 21 題，但只偵測到 10 題
   - 原因：可能是整合時的 level 欄位問題
   - 需要檢查：`gaia_109_tasks.json` 的 level 欄位

---

## 📈 與原本 10 題的對比

| 指標 | 原本 10 題 | 現在 109 題 | 變化 |
|------|-----------|------------|------|
| 題目數 | 10 | 109 | **+1090%** |
| 總步驟數 | 138 | 17,661 | **+12,695%** |
| 平均步驟數 | 13.8 | 162.0 | **+1,074%** |
| 工具種類 | 16 | 3 | **-81%** |
| 推理步驟比例 | 56.5% | 97.6% | **+73%** |
| 驗證率 | - | 100% | - |

---

## 🔧 下一步建議

### 短期（立即可做）
1. **檢查 Level 3 題目數問題**
   - 調查為什麼只偵測到 10 題而非 21 題
   - 檢查 `gaia_109_tasks.json` 的 level 欄位

2. **分析 27 題有錯誤的原因**
   - 讀取 `validation_results_109.json`
   - 找出哪些題目有錯誤、錯誤類型是什麼

3. **改進工具對應規則**
   - 不要將所有 web_browser 都對應到 web_fetch
   - 保留更多工具的多樣性

### 中期（需要時間）
1. **擴充 tools_schema.json**
   - 新增 `python_executor`（執行 Python 程式碼）
   - 新增 `code_interpreter`（執行其他語言）
   - 新增 `pptx_reader`（讀取 PowerPoint）
   - 新增 `audio_transcription`（音訊轉錄）

2. **改進 Parser v5**
   - 處理助教的 DAG 格式
   - 支援參數名稱映射（max_results → num_results）

3. **優化推理步驟處理**
   - 考慮是否要保留所有推理步驟
   - 或者只保留關鍵的推理步驟

### 長期（架構改進）
1. **建立標準化的工具對應表**
   - 定義清楚的對應規則
   - 支援多對一、一對多的對應

2. **統一 GAIA 資料格式**
   - 定義統一的 JSON Schema
   - 自動驗證資料格式

3. **擴展 Data Synthesis**
   - 針對 109 題生成更多變體
   - 提升工具的多樣性

---

## 📁 生成的檔案

1. **gaia_109_tasks.json** (2860 KB)
   - 整合後的 109 題，統一格式

2. **validation_results_109.json**
   - 每題的驗證結果（哪些步驟有效、哪些有錯誤）

3. **analysis_report_109.json**
   - 完整的分析報告（工具使用、參數使用、驗證統計）

4. **integrate_109_tasks.py**
   - 整合腳本（含工具對應規則）

5. **run_109_pipeline.py**
   - Pipeline 執行腳本（驗證 + 分析）

6. **PARSER_PARAMETER_CHECK.md**
   - Parser 參數處理檢查報告

---

## ✅ 總結

### 已完成
- ✓ 整合 109 題（99 助教 + 10 GAIA L3）
- ✓ 檢查 Parser 參數處理能力
- ✓ 建立工具對應規則
- ✓ 執行 Pipeline（驗證 + 分析）
- ✓ 生成完整的報告

### 成果
- ✓ 整體驗證率 100%（所有工具步驟的參數都符合 schema）
- ✓ 資料量擴大 10 倍（從 10 題到 109 題）
- ✓ 發現了推理步驟比例過高的問題

### 待優化
- 改進工具對應規則（保留更多工具多樣性）
- 檢查 Level 3 題目數問題
- 分析 27 題有錯誤的原因
- 擴充 tools_schema.json（新增更多工具）

---

**報告結束**

有任何問題歡迎詢問！
